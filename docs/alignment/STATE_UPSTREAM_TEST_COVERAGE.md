# State Upstream Test Coverage (Mermaid@11.12.2)

This document tracks which upstream Mermaid state diagram parser tests are covered in `merman` via:

- snapshot fixtures under `fixtures/state/*.mmd` (goldens generated by `cargo run -p xtask -- update-snapshots`)
- Rust unit tests under `crates/merman-core/src/diagrams/state.rs`
- upstream SVG baselines under `fixtures/upstream-svgs/state/*.svg` (generated by `cargo run -p xtask -- gen-upstream-svgs --diagram state`)
- SVG DOM compare via `cargo run --release -p xtask -- compare-state-svgs --check-dom --dom-mode parity-root --dom-decimals 3`

Scope: Mermaid tag `@11.12.2`.

## External regression cases

These fixtures are sourced from downstream renderer reports (outside Mermaid's own test suite) and
are parity-gated against upstream SVG baselines:

- mmdr test fixture (basic): `fixtures/state/mmdr_tests_state_state_basic.mmd`
- mmdr test fixture (note): `fixtures/state/mmdr_tests_state_state_note.mmd`

Reference: `docs/alignment/EXTERNAL_FIXTURES.md`.

## Authored stress fixtures

These fixtures are authored in this repository (not copied from Mermaid's upstream test suite),
but are still parity-gated against upstream SVG baselines to cover high-risk state diagram surfaces:

- Batch 2026-02-16 (12 fixtures): `fixtures/state/stress_state_*_013..024.mmd`
  - Focus: concurrent regions (`--`), nested choice + fork/join, quoted multiline names, strict click directives,
    dense graphs, unicode/mixed scripts, long edge labels (Markdown emphasis via `_and_`), composite self-links,
    styles/classes, and comment/whitespace robustness.
  - Baselines: `fixtures/upstream-svgs/state/stress_state_*_013..024.svg`

- Batch 2026-02-16 (12 fixtures): `fixtures/state/stress_state_*_025..036.mmd`
  - Focus: HTML sanitization around notes, Markdown edge labels (emphasis/strong/inline code), dense labeled graphs,
    composite states with external edges, 3-way concurrent regions, nested concurrency + choice, comment/whitespace
    robustness in composite blocks, quoted multiline state names, style/class interactions, click directive matrix
    coverage (href forms to keep upstream CLI baselines reproducible), floating notes/links, and unicode/RTL labels.
  - Baselines: `fixtures/upstream-svgs/state/stress_state_*_025..036.svg`

## `parser/state-parser.spec.js`

Source: `repo-ref/mermaid/packages/mermaid/src/diagrams/state/parser/state-parser.spec.js`

- `state "Small State 1" as namedState1`: `fixtures/state/upstream_state_parser_spec.mmd`
- `namedState1 : Small State 1` (spaces around `:`): `fixtures/state/upstream_state_parser_spec.mmd`
- `namedState1:Small State 1` (no spaces around `:`): `fixtures/state/upstream_state_parser_spec.mmd`
- state ids that include `as` (e.g. `assemble`, `assemblies`): `fixtures/state/upstream_state_parser_spec.mmd`
- `state "as" as as` (quoted description equals keyword): `fixtures/state/upstream_state_parser_spec.mmd`
- composite states:
  - `state "Big State 1" as bigState1 { ... }`: `fixtures/state/upstream_state_parser_spec.mmd`
  - nested `state "inner state 1" as inner1` and `inner2: inner state 2` inside a composite: `fixtures/state/upstream_state_parser_spec.mmd`
- relations that target composite ids (container edges): `fixtures/state/upstream_state_parser_spec.mmd`
- allow unsafe property names as state ids (`__proto__`, `constructor`): `fixtures/state/upstream_state_parser_spec.mmd`

## `parser/state-style.spec.js`

Source: `repo-ref/mermaid/packages/mermaid/src/diagrams/state/parser/state-style.spec.js`

- `classDef` parsing:
  - single style attribute: `fixtures/state/upstream_state_style_spec.mmd`
  - multiple attributes separated by commas: `fixtures/state/upstream_state_style_spec.mmd`
  - numeric values with dots (e.g. `1.5px`): `fixtures/state/upstream_state_style_spec.mmd`
  - values containing spaces (e.g. `background:  #bbb`): `fixtures/state/upstream_state_style_spec.mmd`
  - allow `__proto__` / `constructor` as class ids: `fixtures/state/upstream_state_style_spec.mmd`
- `class` application:
  - apply to a single state: `fixtures/state/upstream_state_style_spec.mmd`
  - apply to ids containing `_`: `fixtures/state/upstream_state_style_spec.mmd`
  - `:::` inline class syntax (including `[*]:::classId`): `fixtures/state/upstream_state_style_spec.mmd`
  - comma-separated state id lists (with/without spaces): `fixtures/state/upstream_state_style_spec.mmd`
- comments inside composite blocks (`%% ...`): `fixtures/state/upstream_state_style_spec.mmd`
- `style` statement:
  - single id: `fixtures/state/upstream_state_style_spec.mmd`
  - comma-separated ids: `fixtures/state/upstream_state_style_spec.mmd`
  - multiple css attributes: `fixtures/state/upstream_state_style_spec.mmd`

## `stateDiagram.spec.js`

Source: `repo-ref/mermaid/packages/mermaid/src/diagrams/state/stateDiagram.spec.js`

- `hide empty description`: `fixtures/state/upstream_stateDiagram_spec.mmd`
- `scale <n> width`: `fixtures/state/upstream_stateDiagram_spec.mmd`
- relation/state descriptions containing `-`: `fixtures/state/upstream_stateDiagram_spec.mmd`
- state ids that include `as` (e.g. `assemble`, `assemblies`): `fixtures/state/upstream_stateDiagram_handle_as_in_state_names_spec.mmd`
- `state "as" as as` (quoted description equals keyword): `fixtures/state/upstream_stateDiagram_handle_as_in_state_names_spec.mmd`
- `accDescr: ...`: `fixtures/state/upstream_stateDiagram_acc_descr_spec.mmd`
- multiline `accDescr { ... }`: `fixtures/state/upstream_stateDiagram_acc_descr_multiline_spec.mmd`
- `accTitle: ...`: `fixtures/state/upstream_stateDiagram_acc_title_spec.mmd`
- `state "Long state description" as state1`: `fixtures/state/upstream_stateDiagram_state_definition_sep_id_simple_spec.mmd`
- composite state with `state "..." as <id> { ... }`: `fixtures/state/upstream_stateDiagram_state_definition_separation_spec.mmd`
- state definition with quoted multiline description: `fixtures/state/upstream_stateDiagram_state_definition_with_quotes_spec.mmd`
- fork/join typed states (`state <id> <<fork>>` / `<<join>>`): `fixtures/state/upstream_stateDiagram_fork_join_spec.mmd`
- concurrent state divider (`--` inside `state <id> { ... }`): `fixtures/state/upstream_stateDiagram_concurrent_state_spec.mmd`
- concurrent state divider (minimal): `fixtures/state/upstream_stateDiagram_concurrent_state_minimal_spec.mmd`
- note statements (left/right + `end note` block): `fixtures/state/upstream_stateDiagram_note_statements_spec.mmd`
- multiline note `<br>` normalization: `fixtures/state/upstream_stateDiagram_multiline_notes_spec.mmd`
- floating notes (`note "..." as <id>`): `fixtures/state/upstream_stateDiagram_floating_notes_spec.mmd`
- note on composite state: `fixtures/state/upstream_stateDiagram_notes_on_composite_states_spec.mmd`
- edge label after second state (`[*] --> State1 : ...`): `fixtures/state/upstream_stateDiagram_edge_label_after_second_state_spec.mmd`
- edge label containing minus signs (`+-!`): `fixtures/state/upstream_stateDiagram_edge_label_including_minus_signs_spec.mmd`
- state statements (`state <id> { ... }`): `fixtures/state/upstream_stateDiagram_state_statements_spec.mmd`
- recursive state definitions: `fixtures/state/upstream_stateDiagram_recursive_state_definitions_spec.mmd`
- multiple recursive state definitions: `fixtures/state/upstream_stateDiagram_multiple_recursive_state_definitions_spec.mmd`
- click directives (`click <id> ...`): `fixtures/state/upstream_stateDiagram_click_directive_spec.mmd`

## `stateDiagram-v2.spec.js`

Source: `repo-ref/mermaid/packages/mermaid/src/diagrams/state/stateDiagram-v2.spec.js`

- `hide empty description`: `fixtures/state/upstream_stateDiagram_v2_spec.mmd`
- `scale <n> width`: `fixtures/state/upstream_stateDiagram_v2_spec.mmd`
- relationship label extraction (`id1 --> id2 : label`): `fixtures/state/upstream_stateDiagram_v2_spec.mmd`
- `accDescr: ...`: `fixtures/state/upstream_stateDiagram_v2_acc_descr_spec.mmd`
- `accTitle: ...`: `fixtures/state/upstream_stateDiagram_v2_acc_title_spec.mmd`
- fork/join typed states (`state <id> <<fork>>` / `<<join>>`): `fixtures/state/upstream_stateDiagram_v2_fork_join_spec.mmd`
- concurrent state divider (`--` inside `state <id> { ... }`): `fixtures/state/upstream_stateDiagram_v2_concurrent_state_spec.mmd`
- note statements (left/right + `end note` block): `fixtures/state/upstream_stateDiagram_v2_note_statements_spec.mmd`
- multiline note `<br>` normalization: `fixtures/state/upstream_stateDiagram_v2_multiline_notes_spec.mmd`
- floating notes (`note "..." as <id>`): `fixtures/state/upstream_stateDiagram_v2_floating_notes_spec.mmd`
- note on composite state: `fixtures/state/upstream_stateDiagram_v2_notes_on_composite_states_spec.mmd`
- composite state self-link (`Active --> Active`): `fixtures/state/upstream_stateDiagram_v2_composite_self_link_spec.mmd`
- state definition with quoted multiline description: `fixtures/state/upstream_stateDiagram_v2_state_definition_with_quotes_spec.mmd`
- default diagram direction when unspecified: `fixtures/state/upstream_stateDiagram_direction_default_spec.mmd`
- explicit diagram direction (`direction LR`): `fixtures/state/upstream_stateDiagram_direction_lr_spec.mmd`

## Cypress rendering specs

Source: `repo-ref/mermaid/cypress/integration/rendering/`

These fixtures are extracted from Cypress browser rendering specs (`imgSnapshotTest` / `renderGraph`)
and are parity-gated against upstream SVG baselines:

- Imported fixtures: `fixtures/state/upstream_cypress_*.mmd` (62 fixtures)
- Import tool: `cargo run -p xtask -- import-upstream-cypress --diagram state`
- Baselines: `cargo run -p xtask -- gen-upstream-svgs --diagram state --filter upstream_cypress_`

## `repo-ref/mermaid/packages/mermaid/src/docs/syntax/stateDiagram.md`

Source: `repo-ref/mermaid/packages/mermaid/src/docs/syntax/stateDiagram.md`

- choice nodes (`state <id> <<choice>>`): `fixtures/state/upstream_stateDiagram_v2_choice_spec.mmd`
- nested composite states (multiple layers): `fixtures/state/upstream_stateDiagram_v2_composite_layers_docs.mmd`
- transitions between composite states: `fixtures/state/upstream_stateDiagram_v2_composite_state_transitions_docs.mmd`
- `:::` operator (inline class application): `fixtures/state/upstream_stateDiagram_triple_colon_operator_docs.mmd`
- spaces in state names (`id: description` + later references): `fixtures/state/upstream_stateDiagram_spaces_in_state_names_docs.mmd`
- `classDef` + `class` statements big example: `fixtures/state/upstream_stateDiagram_docs_classdef_and_class_statements.mmd`
- frontmatter title (`---\\ntitle: ...\\n---`): `fixtures/state/upstream_stateDiagram_v2_frontmatter_title_docs.mmd`

## `repo-ref/mermaid/docs/syntax/stateDiagram.md`

Source: `repo-ref/mermaid/docs/syntax/stateDiagram.md`

- Imported syntax-doc fixtures (complex blocks, CLI baselines enabled):
  - `fixtures/state/upstream_docs_statediagram_state_diagrams_002.mmd`
  - `fixtures/state/upstream_docs_statediagram_state_diagrams_004.mmd`
  - `fixtures/state/upstream_docs_statediagram_states_006.mmd`
  - `fixtures/state/upstream_docs_statediagram_states_008.mmd`
  - `fixtures/state/upstream_docs_statediagram_states_010.mmd`
  - `fixtures/state/upstream_docs_statediagram_transitions_012.mmd`
  - `fixtures/state/upstream_docs_statediagram_transitions_014.mmd`
  - `fixtures/state/upstream_docs_statediagram_start_and_end_016.mmd`
  - `fixtures/state/upstream_docs_statediagram_composite_states_018.mmd`
  - `fixtures/state/upstream_docs_statediagram_composite_states_020.mmd`
  - `fixtures/state/upstream_docs_statediagram_composite_states_022.mmd`
  - `fixtures/state/upstream_docs_statediagram_choice_024.mmd`
  - `fixtures/state/upstream_docs_statediagram_forks_026.mmd`
  - `fixtures/state/upstream_docs_statediagram_notes_028.mmd`
  - `fixtures/state/upstream_docs_statediagram_concurrency_030.mmd`
  - `fixtures/state/upstream_docs_statediagram_setting_the_direction_of_the_diagram_032.mmd`
  - `fixtures/state/upstream_docs_statediagram_comments_034.mmd`
  - `fixtures/state/upstream_docs_statediagram_2_operator_to_apply_a_style_to_a_state_044.mmd`
  - `fixtures/state/upstream_docs_statediagram_spaces_in_state_names_046.mmd`
